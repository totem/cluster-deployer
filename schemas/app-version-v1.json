{
  "$schema": "http://json-schema.org/draft-04/hyper-schema#",
  "type": "object",
  "title": "Schema for creating deployment",
  "id": "#app-version-v1",
  "properties": {
    "meta-info": {
      "$ref": "#/definitions/meta-info"
    },
    "deployment":{
      "$ref": "#/definitions/deployment"
    },
    "proxy":{
      "$ref": "#/definitions/proxy"
    },
    "templates": {
      "$ref": "#/definitions/templates"
    },
    "security": {
      "$ref": "#/definitions/security"
    },
    "notifications": {
      "$ref": "#/definitions/notifications"
    }
  },
  "required": ["meta-info"],
  "additionalProperties": false,
  "definitions":{
    "meta-info": {
      "properties": {
        "git": {
          "$ref": "#/definitions/git"
        },
        "job-id": {
          "type": "string",
          "maxLength": 100
        }
      },
      "additionalProperties": false
    },
    "git": {
      "properties": {
        "owner": {
          "type": "string",
          "maxLength": 100
        },
        "repo": {
          "type": "string",
          "maxLength": 100
        },
        "ref": {
          "type": "string",
          "maxLength": 100
        },
        "commit": {
          "type": "string",
          "maxLength": 100
        }
      },
      "additionalProperties": false
    },
    "deployment": {
      "properties": {
        "name": {
          "type": "string",
          "maxLength": 512
        },
        "version": {
          "type": "string",
          "maxLength": 100
        },
        "type": {
          "enum": [ "blue-green", "red-green", "a/b", "custom"]
        },
        "nodes": {
          "type": "number",
          "maximum": 12,
          "minimum": 1
        },
        "check": {
          "$ref": "#/definitions/deployment-check"
        }
      },
      "additionalProperties": false
    },
    "deployment-check": {
      "properties": {
        "min-nodes": {
          "type": "number",
          "description": "Minimum number of nodes for deployment. (Used for deployment check)",
          "minimum": 1
        },
        "port": {
          "type": "number",
          "description": "Application internal Port to be used for discover check",
          "minimum": 1
        }
      },
      "additionalProperties": false
    },
    "proxy":{
      "properties": {
        "hosts": {
          "type": "object"
        },
        "listeners": {
          "type": "object"
        },
        "upstreams": {
          "type": "object"
        }
      },
      "additionalProperties": false
    },
    "templates": {
      "properties": {
        ".*": {
          "ref": "#/definitions/template"
        }
      },
      "additionalProperties": true
    },
    "template": {
      "properties": {
        "args": {
          "$ref": "#/definitions/template-args"
        }
      },
      "additionalProperties": true
    },
    "template-args": {
      "properties": {
        "image": {
          "type": "string",
          "maxLength": 1024
        },
        "environment": {
          "$ref": "#/definitions/environment"
        },
        "docker-args": {
          "oneOf": [
            {
              "type": "string",
              "maxLength": 1024
            },
            {
              "$ref": "#/definitions/encrypted-type"
            }
          ]
        },
        "command": {
          "oneOf": [
            {
              "type": "string",
              "maxLength": 4096
            },
            {
              "$ref": "#/definitions/encrypted-type"
            }
          ]
        }
      },
      "additionalProperties": true
    },
    "environment": {
      "patternProperties": {
        ".*": {
          "oneOf": [
            {
              "type": "string",
              "maxLength": 4096
            },
            {
              "$ref": "#/definitions/encrypted-type"
            }
          ]
        }
      },
      "additionalProperties": false
    },
    "encrypted-type": {
      "type": "object",
      "properties": {
        "value": {
          "type": "string",
          "maxLength": 8192
        },
        "encrypted": {
          "type": "boolean"
        }
      },
      "additionalProperties": false,
      "required": ["value"]
    },
    "security" : {
      "properties": {
        "profile": {
          "type": "string",
          "maxLength": 100,
          "default": "default"
        }
      },
      "additionalProperties": false
    },
    "notifications": {
      "patternProperties": {
        "hipchat": {
          "ref": "#/definitions/notification-hipchat"
        },
        "github": {
          "ref": "#/definitions/notification-github"
        },
        ".*": {
          "ref": "#/definitions/notification"
        }
      }
    },
    "notification": {
      "properties":{
        "enabled": {
          "type": "boolean",
          "description": "Used for enabling/disabling notification"
        }
      },
      "additionalProperties": true
    },
    "notification-hipchat": {
      "properties":{
        "enabled": {
          "type": "boolean",
          "description": "Used for enabling/disabling notification"
        },
        "url": {
          "type": "string",
          "description": "Hipchat v2 api url"
        },
        "colors": {
          "type": "object",
          "description": "Color mapping"
        },
        "room": {
          "type": "string",
          "description": "Room to be used for notification"
        },
        "token": {
          "description": "Hipchat API v2 token (personal/ room) for notification",
          "oneOf": [
            {
              "type": "string"
            },
            {
              "$ref": "#/definitions/encrypted-type"
            }
          ]
        }
      },
      "additionalProperties": false
    },
    "notification-github": {
      "properties":{
        "enabled": {
          "type": "boolean",
          "description": "Used for enabling/disabling notification"
        },
        "url": {
          "type": "string",
          "description": "Github API url base"
        },
        "token": {
          "description": "Github Oauth token",
          "oneOf": [
            {
              "type": "string"
            },
            {
              "$ref": "#/definitions/encrypted-type"
            }
          ]
        }
      },
      "additionalProperties": false
    }
  },
  "links": [
    {
      "rel": "self",
      "href": "${base_url}/api/secure/hosts/{id}",
      "mediaType": "application/vnd.saleztoolz.host-v1+json",
      "method": "GET"
    },
    {
      "title": "List Hosts",
      "rel": "parent",
      "href": "/api/secure/hosts",
      "mediaType": "application/vnd.saleztoolz.host-list-v1+json",
      "method": "GET"
    },
    {
      "title": "Updates basic host info",
      "rel": "patch",
      "href": "/api/secure/hosts/{id}",
      "mediaType": "application/vnd.saleztoolz.host-patch-v1+json",
      "method": "PUT"
    },
    {
      "title": "Deletes the host from the system",
      "rel": "delete",
      "href": "/api/secure/hosts/{id}",
      "method": "DELETE"
    }
  ]
}